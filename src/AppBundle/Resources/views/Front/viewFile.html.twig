{% extends '@App/base.html.twig' %}

{% set sumSpecimens = 0 %}
{% block body %}
    {% include '@App/Front/partial/breadcrumb.html.twig' %}
    <h1 class="page-header">{{ 'file.stats.title' | trans({'%name%' : institution.institutionCode ~ ' / '~ collectionCode},'user') }}
        <small>
            <a href="{{ path('stats', {'collectionCode' : collectionCode, 'institutionCode':institutionCode}) }}">{{ 'stats.details'| trans }}</a>
        </small>
    </h1>
    {% if stats is not empty %}
        <table class="table table-bordered">
            <tr>
                <th style="width: 10%">{{ 'header.className' | trans}}</th>
                <th style="width: 10%">{{ 'header.nb.specimens' | trans }}</th>
                <th style="width: 10%">{{ 'header.nb.differences' | trans }}</th>
                <th style="width: 10%">{{ 'header.nb.reste' | trans }}</th>
                <th style="width: 10%">{{ 'header.nb.choix' | trans }}</th>
                <th style="width: 10%">{{ 'header.lonesomeRecords.recolnat' | trans }}</th>
                <th style="width: 10%">{{ 'header.lonesomeRecords.institution' | trans }}</th>
            </tr>
            {% for className, detailedStats in stats %}
                <tr class="datas {{ className|lower }}">
                    <td class="className">{{ ('label.'~className|lower) | transchoice(detailedStats.specimens, {}, 'entity')|capitalize }}</td>
                    {% set transClass=('label.'~className|lower) | transchoice(detailedStats.specimens, {}, 'entity') %}
                    <td class="nbSpecimens">
                        {% if detailedStats.specimens > 0 %}
                            <a href="{{ path('diffs', {'collectionCode' : collectionCode, 'institutionCode':institutionCode, 'selectedClassName' : className|lower}) }}">
                                {{ detailedStats.specimens }}
                            </a>
                        {% else %}
                            0
                        {% endif %}
                    </td>
                    <td class="nbDiffs">
                        <a href="{{ path('diffs', {'collectionCode' : collectionCode, 'institutionCode':institutionCode, 'selectedClassName' : className|lower}) }}">
                            {{ detailedStats.diffs }}
                        </a>
                    </td>
                    <td class="nbTodos">
                        {% set nbTodos = attribute(statsChoices, className) is defined ? detailedStats.diffs - attribute(statsChoices, className) : detailedStats.diffs %}
                        {% if nbTodos > 0 %}
                            <a href="{{ path('todos', {'collectionCode' : collectionCode, 'institutionCode':institutionCode, 'selectedClassName' : className|lower}) }}">
                                {{ nbTodos }}
                            </a>
                        {% else %}
                            0
                        {% endif %}
                    </td>
                    <td class="nbChoices">
                        {% set nbChoices = attribute(statsChoices, className) is defined ? attribute(statsChoices, className) : 0 %}
                        {% if nbChoices > 0 %}
                            <a href="{{ path('choices', {'collectionCode':collectionCode,'institutionCode':institutionCode,'selectedClassName':className|lower}) }}"
                               title="">
                                {{ nbChoices }}
                            </a>
                        {% else %}
                            0
                        {% endif %}
                    </td>
                    <td>
                        {% if attribute(statsLonesomeRecords, className)['recolnat'] > 0 %}
                            <a href="{{ path('lonesomes', {'db':'recolnat','collectionCode':collectionCode,'institutionCode':institutionCode,'selectedClassName':className|lower}) }}">
                                {{ attribute(statsLonesomeRecords, className)['recolnat'] }}
                            </a>
                        {% else %}
                            0
                        {% endif %}
                    </td>
                    <td>
                        {% if attribute(statsLonesomeRecords, className)['institution'] > 0 %}
                        <a href="{{ path('lonesomes', {'db':'institution','collectionCode':collectionCode,'institutionCode':institutionCode,'selectedClassName':className|lower}) }}">
                            {{ attribute(statsLonesomeRecords, className)['institution'] }}
                        </a>
                        {% else %}
                            0
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            <tr>
                <td>{{ 'label.total' | trans }}</td>
                <td>
                    <a href="{{ path('diffs', {'collectionCode':collectionCode,'institutionCode':institutionCode}) }}">
                        {{ sumStats.specimens }}
                    </a>
                </td>
                <td>
                    <a href="{{ path('diffs', {'collectionCode':collectionCode,'institutionCode':institutionCode}) }}">
                        {{ sumStats.diffs }}
                    </a>
                </td>
                <td>
                    <a href="{{ path('todos', {'collectionCode':collectionCode,'institutionCode':institutionCode}) }}">
                        {{ sumStats.diffs - statsChoices.sum }}
                    </a>
                </td>
                <td>
                    <a href="{{ path('choices', {'collectionCode':collectionCode,'institutionCode':institutionCode}) }}">
                        {{ statsChoices.sum }}
                    </a>
                </td>
                <td>
                    <a href="{{ path('lonesomes', {'db':'recolnat','collectionCode':collectionCode,'institutionCode':institutionCode}) }}">
                        {{ sumLonesomeRecords.recolnat }}
                    </a>
                </td>
                <td>
                    <a href="{{ path('lonesomes', {'db':'institution','collectionCode':collectionCode,'institutionCode':institutionCode}) }}">
                        {{ sumLonesomeRecords.institution }}
                    </a>
                </td>
            </tr>
        </table>
    {% endif %}
    <div class="row">
        <div class="col-sm-6 col-md-6">
            <a data-toggle="modal" href="{{ path('setPrefsForExport', {'type':'dwc', 'collectionCode' : collectionCode, 'institutionCode' : institutionCode}) }}"
               class=" btn btn-default checkprefs" role="button" data-target="#spinnerModal">
                {{ 'downloadDwc'|trans }}
            </a>
            <a data-toggle="modal" href="{{ path('setPrefsForExport', {'type':'csv', 'collectionCode' : collectionCode, 'institutionCode' : institutionCode}) }}"
               class=" btn btn-default checkprefs" role="button" data-target="#spinnerModal">
                {{ 'downloadCsv'|trans }}
            </a>
        </div>
        <div class="col-sm-6 col-md-6">
            <a href="{{ path('deleteChoices', {'collectionCode' : collectionCode, 'institutionCode' : institutionCode}) }}"
               class="delete deleteChoices btn btn-default" role="button">
                {{ 'delete.choices'|trans }}
            </a>
            <a href="{{ path('deleteDiffs', {'collectionCode' : collectionCode, 'institutionCode' : institutionCode}) }}"
               class="delete deleteDiffs btn btn-default" role="button">
                {{ 'delete.diffs'|trans }}
            </a>
        </div>
        <div class="col-sm-6 col-md-6">

        </div>
    </div>
    {% include '@App/Front/partial/modal.html.twig' %}


    <svg class="chart"></svg>
{% endblock %}


{% block javascripts %}
    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript">
        var collectionCode = '{{ collectionCode }}' ;
        var institutionCode = '{{ institutionCode }}' ;
        var datas = [
            {% for className, detailedStats in stats %}
            {
                name: '{{ className|lower }}',
                specimens: {{ detailedStats.specimens }},
                differences: {{ detailedStats.diffs }},
                todos: {{ attribute(statsChoices, className) is defined ? detailedStats.diffs - attribute(statsChoices, className) : detailedStats.diffs }},
                choices: {{ attribute(statsChoices, className) is defined ? attribute(statsChoices, className) : 0 }},
                excluRecolnat: {{ attribute(statsLonesomeRecords, className)['recolnat'] }},
                excluInstitution: {{ attribute(statsLonesomeRecords, className)['institution'] }}
            }
            {{ loop.last == false ? ',':'' }}

            {% endfor %}
        ];
    </script>
    <script src="{{ asset('assets/AppBundle/js/viewFile.js') }}"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            var modalSpinner = $("#spinnerModal");
            $(".checkprefs").on('click', function (event) {
                var url = $(this).attr('href');
                var modalPrefs = $("#modal").clone();
                $.get(url, function(data) {
                    modalPrefs.find('.modal-body').html(data);
                    modalPrefs.modal('show');
                })
                .success(function() {
                    var urlDownload = modalPrefs.find('form').attr('action') ;
                    modalPrefs.find('.confirm').on('click', function (event) {
                        $.ajax({
                            url: urlDownload,
                            method: "POST",
                            data:modalPrefs.find('form').serialize(),
                            beforeSend: function () {
                                modalSpinner.find('.modal-body h4').remove();
                                modalSpinner.find('.modal-body').prepend('<h4 class="modal-title center-block">Génération des fichiers en cours</h4>');
                            }
                        })
                        .success(function (data) {
                            path = Routing.generate('download', {path: data.file});
                            window.location = path;
                        });
                    });
                });
                event.preventDefault();
            });

            $(".delete").on('click', function (event) {
                var modalDelete = $("#modal").clone();
                var urlDeleteChoices = $(this).attr('href');
                if ($(this).hasClass('deleteChoices')) {
                    modalDelete.find('.modal-title').html('{{ 'deleteChoices.title' | trans }}');
                    modalDelete.find('.modal-body>p').html('{{ 'deleteChoices.text' | trans }}');
                }
                else {
                    modalDelete.find('.modal-title').html('{{ 'deleteDiffs.title' | trans }}');
                    modalDelete.find('.modal-body>p').html('{{ 'deleteDiffs.text' | trans }}');
                }
                modalDelete.modal('show');
                modalDelete.find('.confirm').on('click', function (event) {
                    event.preventDefault();
                    $.ajax({
                                url: urlDeleteChoices,
                                method: "POST",
                                global: false, // désactive le spinner
                                beforeSend: function () {
                                    modalDelete.modal('hide');
                                    modalSpinner.find('.modal-body').append('<p class="text-center">{{ 'generateDiffs' | trans }}</p>');
                                    modalSpinner.modal('show');
                                }
                            })
                            .done(function (data) {
                                console.log(data);
                            })
                            .success(function () {
                                window.location.reload();
                            });
                });
                event.preventDefault();
            })
        });
    </script>
{% endblock %}