{% extends '@App/base.html.twig' %}

{% block body %}
    <div class="container-fluid">
        <h1 class="page-header row">{{ 'welcome' | trans({'%name%' : app.user},'user') }}</h1>
        {% if managedCollections|length > 0 %}
            {% dump(managedCollections) %}
            {% dump(diffHandlers) %}
            {% for collection in managedCollections %}
                {% set collectionCode = collection.collectionCode %}
                <div class="row">
                    {% if diffHandlers[collectionCode] is defined and diffHandlers[collectionCode].shouldSearchDiffs == false %}
                        <div class="col-sm-2">
                            {{ 'label.collection' | trans }} :

                            <a href="{{ path('viewfile', {'collectionCode':collectionCode}) }}">
                                {{ collectionCode }}
                            </a>
                        </div>

                        <ul class="col-sm-3">
                            <li>{{ 'fichier.creele'|trans({'%date%': diffHandlers[collectionCode].getCTime|date("d/m/Y"), '%heure%' :diffHandlers[collectionCode].getCTime|date("H:i:s")}) }}</li>
                            <li>{{ 'fichier.modifiele'|trans({'%date%': diffHandlers[collectionCode].getMTime|date("d/m/Y"), '%heure%' :diffHandlers[collectionCode].getMTime|date("H:i:s")}) }}</li>
                        </ul>
                    {% else %}
                        <div class="col-sm-2">
                            {{ 'label.collection' | trans }} :
                            {{ collectionCode }}
                        </div>
                        <div class="col-sm-3">
                            {{ 'label.nodiffs' | trans }}
                        </div>
                    {% endif %}
                    <a class="col-sm-3 searchDiffButton btn btn-primary" role="button"
                       href="{{ path('configureSearchDiff', {'collectionCode' : collectionCode}) }}">
                    <span class="glyphicon glyphicon-search"
                          aria-hidden="true"></span> {{ 'label.searchDiffs' | trans }}
                    </a>
                </div>
            {% endfor %}
        {% endif %}
    </div>
    {% include "@App/Front/partial/searchDiffModal.html.twig" %}
{% endblock %}
{#
{% block javascripts %}
    <script type="text/javascript">
        $(document).ready(function () {
            $("a.searchDiffButton").on('click', function (event) {
                event.preventDefault();
                $("#modal").modal({
                    backdrop: 'static',
                    keyboard: false
                }).modal('show');

                var progressbar = $("#modal").find(".progress-bar");
                var steps;

                try {
                    var source = new EventSource($(this).attr('href'));
                    source.onopen = function () {
                        return;
                    };
                    source.addEventListener('steps', function (evt) {
                        console.log(evt);
                        steps = parseInt(evt.data);
                    });
                    source.addEventListener('step', function (evt) {
                        data = jQuery.parseJSON(evt.data);
                        progress(parseInt(data.count) / steps * 100, progressbar, data.step);
                        if (parseInt(data.count) === steps) {
                            source.close();
                            window.location.reload();
                        }
                    });

                } catch (e) {
                    console.log(e);
                }
            });
            function progress(percent, $element, label) {
                $element.css('width', percent + "%").html(Math.ceil(percent) + "%");
                $element.parent().next().html(Translator.trans(label));
            }
        });


    </script>
{% endblock %}#}
